name: Validate and Sync AOI Artifacts

on:
  push:
    branches:
      - main
    paths:
      - "docs/site/aoi_reports/runs/**"
      - "scripts/**"
      - ".github/workflows/validate-and-sync-artifacts.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run S3 sync in dry-run mode"
        required: true
        default: true
        type: boolean
      delete_extra:
        description: "Delete objects in S3 not present in SOURCE_DIR"
        required: true
        default: false
        type: boolean

permissions:
  contents: read

env:
  SOURCE_DIR: docs/site/aoi_reports/runs

jobs:
  validate-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate AOI artifacts
        run: |
          python3 scripts/validate_aoi_run_artifacts.py --runs-dir docs/site/aoi_reports/runs
          python3 scripts/test_aoi_report_renderer.py
          python3 scripts/test_aoi_report_integration.py
          bash scripts/check_links_local.sh --site-root docs/site
          python3 scripts/check_nav_links.py --site-root docs/site --run-id example

      - name: Ensure S3-compatible target is configured
        if: ${{ vars.S3_ARTIFACTS_URI != '' }}
        run: |
          if [ -z "${{ vars.S3_ENDPOINT_URL }}" ]; then
            echo "S3 sync requested but vars.S3_ENDPOINT_URL is missing."
            exit 1
          fi
          if [ -z "${{ secrets.S3_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.S3_SECRET_ACCESS_KEY }}" ]; then
            echo "S3 sync requested but S3 credentials are missing."
            echo "Set secrets.S3_ACCESS_KEY_ID and secrets.S3_SECRET_ACCESS_KEY."
            exit 1
          fi

      - name: Sync AOI artifacts to S3
        if: ${{ vars.S3_ARTIFACTS_URI != '' }}
        env:
          S3_ARTIFACTS_URI: ${{ vars.S3_ARTIFACTS_URI }}
          S3_ENDPOINT_URL: ${{ vars.S3_ENDPOINT_URL }}
          S3_FORCE_PATH_STYLE: ${{ vars.S3_FORCE_PATH_STYLE || 'true' }}
          AWS_REGION: ${{ vars.S3_REGION || vars.AWS_REGION || 'us-east-1' }}
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
          DELETE_EXTRA: ${{ github.event_name == 'workflow_dispatch' && inputs.delete_extra || 'false' }}
        run: |
          bash scripts/sync_aoi_artifacts_to_s3.sh

      - name: Skip S3 sync (not configured)
        if: ${{ vars.S3_ARTIFACTS_URI == '' }}
        run: |
          echo "vars.S3_ARTIFACTS_URI is empty, validation completed but S3 sync was skipped."
